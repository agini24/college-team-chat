<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Team Chat</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#D10F2F">

  <style>
    /* ------- Luxe Black/Red iMessage-inspired shell ------- */
    :root{
      --bg:#0A0A0B;           /* near-black background */
      --surface:#111214;      /* card surface */
      --elev:#16181B;         /* elevated surface */
      --ink:#EDEEF0;          /* primary text */
      --muted:#A1A5AD;       /* secondary text */
      --line:#23262B;        /* borders */
      --accent:#D10F2F;      /* deep luxury red */
      --accent-ink:#fff;
      --radius:18px;
      --shadow:0 16px 48px rgba(0,0,0,.35);
      --font: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Text",
              "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(1200px 800px at 70% -10%,#111214 0%,#0A0A0B 60%,#070708 100%);
      color:var(--ink);font-family:var(--font);-webkit-font-smoothing:antialiased;letter-spacing:.2px;
    }

    /* Header */
    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg, rgba(10,10,11,.8), rgba(10,10,11,.55));
      backdrop-filter: blur(10px) saturate(1.25);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px}
    h1{margin:2px 0 10px;font-size:20px;font-weight:700;letter-spacing:.3px}

    /* Segmented tabs â€” iOS feel with luxe styling */
    .seg{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .seg-box{
      display:inline-flex;gap:6px;padding:6px;
      background:#0E0F11;border:1px solid var(--line);
      border-radius:999px;box-shadow:var(--shadow);
    }
    .seg button{
      appearance:none;border:0;cursor:pointer;
      padding:9px 16px;border-radius:999px;font-weight:700;
      color:var(--muted);background:transparent;transition:.15s ease;
    }
    .seg button.active{
      background:linear-gradient(180deg, #E01538, #C70D2C);
      color:var(--accent-ink);box-shadow:0 10px 30px rgba(209,15,47,.35);
    }
    .pill{
      margin-left:auto;display:inline-flex;align-items:center;
      gap:8px;padding:7px 12px;border:1px solid var(--line);
      border-radius:999px;font-size:12px;color:var(--muted);
      background:linear-gradient(180deg,#0F1012,#0C0D0F);
    }

    /* Layout */
    main{padding:18px}
    .grid{
      max-width:1200px;margin:0 auto;
      display:grid;grid-template-columns:360px 1fr;gap:18px;
    }
    @media (max-width:1080px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg,#111214,#0E0F11);box-shadow:var(--shadow);
    }
    .panel h3{
      margin:0;padding:14px 16px;border-bottom:1px solid var(--line);
      font-size:13px;color:var(--muted);font-weight:800;letter-spacing:.35px;text-transform:uppercase;
    }
    .panel .body{padding:14px 16px}

    /* Fields & buttons */
    .field{display:flex;flex-direction:column;margin-bottom:12px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input{
      padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:#0B0C0E;color:var(--ink);
      outline:none;transition:border-color .15s ease, box-shadow .15s ease;
    }
    input::placeholder{color:#7C818A}
    input:focus{border-color:#2B2E34;box-shadow:0 0 0 3px rgba(209,15,47,.25)}

    .btn{
      padding:12px 14px;border-radius:14px;border:1px solid #8E0C21;
      background:linear-gradient(180deg, #E01538, #C70D2C);color:#fff;font-weight:800;cursor:pointer;
      box-shadow:0 12px 28px rgba(209,15,47,.35);transition:transform .04s ease, filter .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:#0B0C0E;color:var(--ink);border-color:var(--line);
      box-shadow:none;
    }
    .btn.ghost:hover{filter:brightness(1.08)}

    /* Chat mount */
    #chatMount{
      height:76vh;min-height:520px;border:1px solid var(--line);
      border-radius:16px;overflow:hidden;background:#0B0C0E;
    }
    @media (min-height:900px){#chatMount{height:80vh}}

    /* Thin separators */
    .rule{border:none;border-top:1px solid var(--line);margin:16px 0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>College Team Chat</h1>

      <!-- Segmented control -->
      <div class="seg" id="tabs">
        <div class="seg-box" role="tablist" aria-label="Chat sections">
          <button class="active" id="tabTeam" role="tab" aria-selected="true">Team Chat</button>
          <button id="tabAnn" role="tab" aria-selected="false">Coach Announcements</button>
          <button id="tabQna" role="tab" aria-selected="false">Questions</button>
        </div>
        <span id="whoami" class="pill">Not logged in</span>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: Login / DM / Groups -->
      <div class="panel">
        <h3>Login & Quick Actions</h3>
        <div class="body">
          <div class="field">
            <label>UID (e.g., <b>p_john</b> or <b>coach_andrew</b>)</label>
            <input id="uidInput" placeholder="e.g., p_john" />
          </div>
          <div class="field">
            <label>Display name</label>
            <input id="nameInput" placeholder="John Smith" />
          </div>
          <button id="doLogin" class="btn">Log in now</button>

          <hr class="rule"/>

          <div class="field">
            <label>Direct message (enter UID)</label>
            <input id="dmUid" placeholder="e.g., p_mary" />
          </div>
          <button id="startDm" class="btn ghost">Open Direct Message</button>

          <hr class="rule"/>

          <div class="field">
            <label>Create a small group (comma-separated UIDs)</label>
            <input id="groupUids" placeholder="p_mary,p_john,p_ali" />
          </div>
          <div class="field">
            <label>Group name</label>
            <input id="groupName" placeholder="Forwards" />
          </div>
          <button id="makeSmallGroup" class="btn ghost">Create & Open Group</button>
        </div>
      </div>

      <!-- RIGHT: Chat -->
      <div class="panel">
        <h3>Chat</h3>
        <div class="body">
          <div id="chatMount"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- CometChat Widget SDK -->
  <script src="https://widget-js.cometchat.io/v3/cometchatwidget.js"></script>
  <script>
    /*************** CONFIG ***************/
    const CC_APP_ID  = "2808186f24275c0e";
    const CC_REGION  = "us";
    const CC_AUTHKEY = "d20ca03513ab3c8c65c84f3429e7fd84a0deeb34";

    // Groups
    const GROUP_TEAM_ID = "team_chat";
    const GROUP_ANN_ID  = "announcements";
    const GROUP_QNA_ID  = "questions";

    // Coach UIDs (to keep Announcements composer enabled)
    const COACH_UIDS = ["coach_andrew"]; // add more coach UIDs as needed

    /*************** STATE ***************/
    let loggedInUID = null;
    let widgetReady = false;
    let activeTab = "team"; // team | ann | qna

    /*************** HELPERS ***************/
    const $ = s => document.querySelector(s);
    function isCoach(uid){ return COACH_UIDS.includes(uid); }
    function setWho(s){ $("#whoami").textContent = s; }
    function setActiveTab(which){
      activeTab = which;
      $("#tabTeam").classList.toggle("active", which==="team");
      $("#tabAnn").classList.toggle("active", which==="ann");
      $("#tabQna").classList.toggle("active", which==="qna");
      $("#tabTeam").setAttribute("aria-selected", which==="team");
      $("#tabAnn").setAttribute("aria-selected", which==="ann");
      $("#tabQna").setAttribute("aria-selected", which==="qna");
    }

    // Hide message composer for non-coaches in Announcements (UI side)
    function hideComposerIfNeeded(){
      if (activeTab !== "ann" || isCoach(loggedInUID)) return;
      const attempt = () => {
        const composer = document.querySelector('#chatMount [class*="Composer"], #chatMount textarea, #chatMount [role="textbox"]');
        if (composer && composer.closest) {
          const container = composer.closest("div");
          if (container) container.style.display = "none";
        }
      };
      attempt(); setTimeout(attempt, 250); setTimeout(attempt, 800);
    }

    async function ensureGroup(id, title, type="PUBLIC"){
      const CC = CometChatWidget.CometChat;
      try { await CC.getGroup(id); }
      catch {
        const g = new CC.Group(id, CC.GROUP_TYPE[type], title);
        await CC.createGroup(g);
      }
    }

    async function openGroup(id, title){
      await ensureGroup(id, title);
      await CometChatWidget.launch({
        widgetID: "default",
        target: "#chatMount",
        roundedCorners: "true",
        height: "100%",
        width: "100%",
        defaultID: id,
        defaultType: "group"
      });
      hideComposerIfNeeded();
    }

    async function openDM(uid){
      await CometChatWidget.launch({
        widgetID: "default",
        target: "#chatMount",
        roundedCorners: "true",
        height: "100%",
        width: "100%",
        defaultID: uid,
        defaultType: "user"
      });
    }

    /*************** INIT + LOGIN ***************/
    (async () => {
      try {
        // Provide authKey at init so widget can use it internally
        await CometChatWidget.init({ appID: CC_APP_ID, appRegion: CC_REGION, authKey: CC_AUTHKEY });
        widgetReady = true;

        const suid = localStorage.getItem("ctc_uid");
        const sname = localStorage.getItem("ctc_name");
        if (suid && sname) { await ccLogin(suid, sname); }
      } catch (e) {
        console.error("CometChat init failed", e);
        alert("Chat failed to initialise. Refresh and try again.");
      }
    })();

    async function ccLogin(uid, name){
      if (!widgetReady) { alert("Chat not ready yet. Try again in a second."); return; }
      try {
        await CometChatWidget.login({ uid });
      } catch (e) {
        // auto-create if missing
        await CometChatWidget.createOrUpdateUser({ uid, name }, CC_AUTHKEY);
        await CometChatWidget.login({ uid });
      }
      loggedInUID = uid;
      localStorage.setItem("ctc_uid", uid);
      localStorage.setItem("ctc_name", name);
      setWho("Logged in as: " + name + " (" + uid + ")");

      // open current tab after login
      if (activeTab === "ann") openGroup(GROUP_ANN_ID, "Coach Announcements");
      else if (activeTab === "qna") openGroup(GROUP_QNA_ID, "Questions");
      else openGroup(GROUP_TEAM_ID, "Team Chat (All Players)");
    }

    /*************** UI EVENTS ***************/
    $("#doLogin").onclick = async () => {
      const uid = $("#uidInput").value.trim();
      const name = $("#nameInput").value.trim();
      if (!uid || !name) return alert("Enter UID and Name");
      await ccLogin(uid, name);
    };

    $("#tabTeam").onclick = async () => { setActiveTab("team"); await openGroup(GROUP_TEAM_ID, "Team Chat (All Players)"); };
    $("#tabAnn").onclick  = async () => { setActiveTab("ann");  await openGroup(GROUP_ANN_ID,  "Coach Announcements");     };
    $("#tabQna").onclick  = async () => { setActiveTab("qna");  await openGroup(GROUP_QNA_ID,  "Questions");                };

    $("#startDm").onclick = async () => {
      const uid = $("#dmUid").value.trim();
      if (!uid) return alert("Enter a UID to DM");
      await openDM(uid);
    };

    $("#makeSmallGroup").onclick = async () => {
      const list = $("#groupUids").value.trim();
      const name = $("#groupName").value.trim() || "Small Group";
      if (!list) return alert("Enter comma-separated UIDs");
      const ids = list.split(",").map(s => s.trim()).filter(Boolean);
      const CC = CometChatWidget.CometChat;
      const gid = "grp_" + name.toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,30);
      await ensureGroup(gid, name);
      const members = ids.map(u => new CC.GroupMember(u, CC.GROUP_MEMBER_SCOPE.PARTICIPANT));
      try { await CC.addMembersToGroup(gid, members, []); } catch(e){}
      await openGroup(gid, name);
    };

    // Optional PWA worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }
  </script>
</body>
</html>
